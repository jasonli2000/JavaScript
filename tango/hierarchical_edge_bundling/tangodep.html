<!DOCTYPE html>
<meta charset="utf-8">
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700|Roboto:400,700' rel='stylesheet' type='text/css'>
<!-- try to use google offline/local fonts
<link href='googlefonts.css' rel='stylesheet' type='text/css'>
-->
<link href='d3.dependencyedgebundling.css' rel='stylesheet' type='text/css'>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
<script src="d3.dependencyedgebundling.js"></script>
<script src = "dagre.min.js"></script>
<script>
  var chart = d3.chart.dependencyedgebundling();
  //var rooturl = location.host;
  //var ajaxpath = "http://" + rooturl + "/cdash/ajax/getsubprojectdependencies.php?project=test";
  var localpath = "tangodep.json";

  $(function() {
    $('#selectedsort').on("change", function(e) {
      selected = $(this).val();
      if (parseInt(selected) === 1) {
        localpath = "tangodep_layer.json";
      } else if (parseInt(selected) === 0) {
        localpath = "tangodep.json";
      }
      resetDepView();
    });

  });

  function resetDepView() {
    d3.select('#chart_placeholder svg').remove();
    d3.json(localpath, function(error, classes) {
      if (error){
        errormsg = "json error " + error + " data: " + classes;
        document.write(errormsg);
        return;
      }

      d3.select('#chart_placeholder')
        .datum(classes)
        .call(chart);
    });
  }

</script>
<body>
<label for="selectedsort">Group By:</label>
<select id="selectedsort">
  <option value="0" selected="selected">None</option>
  <option value="1">Layered Clustering</option>
</select>
<div style="font-size:10px; position:absolute; right:100px; top:30px;">
  <button onclick="download_svg()">Download as svg file</button>
</div>
<div id="chart_placeholder"></div>
<script>
resetDepView();
function groupByDagre(classes) {
  var g = new dagre.Digraph();
  var indexMap = {};
  classes.forEach(function(v, index) {
    g.addNode(v.name, { label: "0",  width: 10, height: 10 });
    indexMap[v.name] = index;
  });

  classes.forEach(function(v) {
    if (v.depends) {
      v.depends.forEach(function(i) {
        g.addEdge(null, v.name, i);
      });
    }
  });
  var layout = dagre.layout().run(g);
  var layer = [];
  layout.eachNode(function(u, value) {
    if (layer.indexOf(value.y) === -1) {
      layer.push(value.y);
    }
  });
  layer.sort(function(a,b) { return a - b;} );
  console.log(layer);
  layout.eachNode(function(u, value) {
    var idx = layer.indexOf(value.y);
    var groupId = layer.slice(0,idx+1).join(".");
    classes[indexMap[u]].group = groupId;
  });
  console.log(JSON.stringify(classes));
}

// function for download using svg-crowbar
function download_svg() {
  var e = document.createElement('script');

  if (window.location.protocol === 'https:') {
    e.setAttribute('src', 'https://rawgit.com/NYTimes/svg-crowbar/gh-pages/svg-crowbar.js');
  }
  else {
    e.setAttribute('src', 'http://nytimes.github.com/svg-crowbar/svg-crowbar.js');
  }
  e.setAttribute('class', 'svg-crowbar');
  document.body.appendChild(e);
}
</script>

